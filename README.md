# HRRR Weather Model Processing System

High-performance pipeline for downloading, processing, and visualizing HRRR, RRFS, and GFS weather model data. Pure NumPy calculations with SPC-compliant severe weather parameters.

## Quick Start

```bash
# Setup (conda)
conda env create -f environment.yml
conda activate hrrr_maps
pip install -e .

# Process latest severe weather
hrrr-maps --latest --categories severe --map-workers 8

# Interactive mode
hrrr-cli interactive
```

Some products require `wgrib2` for reliable extraction (included in `environment.yml`).
If you run headless, set `MPLBACKEND=Agg` to avoid Qt warnings.

## Features

- **100+ weather parameters** across severe, instability, smoke, surface, reflectivity, and more
- **SPC-compliant** tornado/supercell parameters (STP, SCP, SHIP, EHI)
- **Parallel processing** with configurable workers
- **Multi-model support**: HRRR, RRFS, GFS
- **Diurnal analysis** with rolling 24h windows
- **Animated GIFs** from forecast sequences

## Usage

### Basic Processing

```bash
# Latest model run, specific categories
hrrr-maps --latest --categories severe,instability --hours 0-12

# Specific date/cycle
hrrr-maps 20251224 12 --categories smoke --map-workers 8

# Single fields
hrrr-maps --latest --fields stp_fixed,sbcape,srh_01km
```

### Performance Tuning

```bash
# Overlap downloads with plotting and cap map workers
hrrr-maps --latest --categories severe --map-workers 14 --download-workers 2 --prefetch 2
```

### Compute-Only Benchmarking

```bash
# Load and compute fields without generating maps
hrrr-maps 20251227 16 --hours 0-18 --compute-only --map-workers 14
```

### Diurnal Temperature Analysis

```bash
# Rolling 24h temperature range across 48h forecast
python tools/process_diurnal.py --latest --synoptic --end-fhr 48 --rolling --workers 12 --gif
```

### Animations

```bash
cd tools
python create_gifs.py 20251224 12z --categories severe --max-hours 24
```

### Continuous Monitoring

```bash
python monitor_continuous.py &
```

### Progress Monitoring

```bash
# Live progress for a running cycle
python tools/progress_monitor.py 2025122717 --hours 0-18 --interval 15 --show-sizes
```

## Project Structure

```
├── processor_cli.py          # Main CLI
├── hrrr_cli.py               # Interactive CLI (Rich/Typer)
├── smart_hrrr/               # Core processing modules
├── derived_params/           # 80+ derived parameter calculations
├── parameters/               # JSON configs by category
├── config/colormaps.py       # Custom colormaps
├── core/                     # GRIB loading, plotting
├── tools/                    # GIF creation, diurnal processing
└── outputs/                  # Generated maps
```

## Pipeline Overview

The processing path is unified:

```
processor_cli.py → smart_hrrr/orchestrator.py → smart_hrrr/pipeline.py → smart_hrrr/parallel_engine.py
```

Stages: download → stage GRIBs → load base fields → compute derived fields → plot maps.

Diurnal products are generated by `tools/process_diurnal.py` and are not part of the standard
field registry.

## Parameters

### Severe Weather (SPC-Aligned)
| Parameter | Description |
|-----------|-------------|
| `stp_fixed` | Significant Tornado Parameter (fixed layer) |
| `stp_effective` | STP with effective inflow layer |
| `scp` | Supercell Composite Parameter |
| `ship` | Significant Hail Parameter |
| `ehi_spc` | Energy-Helicity Index |

### Other Categories
- **Instability**: CAPE/CIN variants, lifted index, LCL height
- **Surface**: Temperature, dewpoint, winds, pressure
- **Smoke/Fire**: Near-surface smoke, visibility, ventilation rate
- **Reflectivity**: Composite, 1km/4km AGL
- **Heat Stress**: Wet bulb, WBGT variants
- **Diurnal**: Temperature range, heating/cooling rates

Run `python processor_cli.py --list-fields` for the full list.

## Adding Parameters

### Base GRIB Field
Add to `parameters/<category>.json`:
```json
{
  "my_field": {
    "var": "TMP",
    "level": "2 m above ground",
    "title": "2m Temperature",
    "units": "K",
    "cmap": "RdYlBu_r"
  }
}
```

### Derived Parameter
Create `derived_params/my_calc.py`:
```python
import numpy as np

def my_calculation(temp, dewpoint):
    return temp - dewpoint
```

Add to `parameters/derived.json`:
```json
{
  "my_derived": {
    "derived": true,
    "function": "my_calculation",
    "inputs": ["t2m", "d2m"],
    "title": "Temp-Dewpoint Spread",
    "units": "K"
  }
}
```

## Output Structure

```
outputs/hrrr/20251224/12z/
├── F00/conus/F00/severe/      # Maps by category
├── F01/conus/F01/instability/
├── diurnal/                    # Diurnal products
└── animations/                 # GIFs
```

## Environment Variables

```bash
HRRR_MAP_WORKERS=12        # Override map worker count
HRRR_DEBUG=1               # Verbose logging
```

## Data Sources

- **NOMADS** (primary): ~2 days retention
- **AWS S3** (backup): Historical archive
- **Utah Pando** (fallback): Research archive

HRRR data typically available 45-75 min after model run time. Synoptic cycles (00/06/12/18Z) have 48h forecasts; others have 18h.

## Docs

- [Architecture Overview](docs/ARCHITECTURE.md)
- [Diurnal Temperature Analysis](docs/DIURNAL_TEMPERATURE.md)
- [Setup Guide](SETUP.md)
